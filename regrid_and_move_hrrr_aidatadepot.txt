#!/bin/bash

# Paths relative to RTMA/alex.schein directory
HRRR_PATH=/ai-datadepot/models/hrrr/conus/grib2
REGRID_PATH=/scratch/RTMA/alex.schein/Regridded_HRRR_aidatadepot

##### REGRID FILES, PUT THEM INTO REGRIDDED DIRECTORY #####

cd ${HRRR_PATH}

for yyyymmdd in * 
do
	cd ${yyyymmdd} #now working in /ai-datadepot/models/hrrr/conus/grib2/[yyyymmdd]
	cwd_hrrr_yyyymmmdd=$PWD
	echo ${yyyymmdd}

    # IMPORTANT: Assuming only f00 files in the ai-datadepot directories! NEED TO MODIFY THE if CONDITIONS WHEN f01 DATA GETS ADDED!!!
    for file in *; do
        if [[ "${file}" == *"wrfnat"* ]]; then 
            if [[ ! "${file}" == *"idx" ]]; then #make sure it's not trying to do anything with the index files, if they exist
                # Extract just the tXXz part of file name, assuming it looks like [something].tXXz.something.grib2
                tXXz=${file#*.}
                tXXz=${tXXz%.*}
                tXXz=${tXXz%.*}
        
                #Can't use same filename when regridding, hence have to split this up
                tmpfilename="temp.grib2"
                newfilename="hrrr_regridded_${yyyymmdd}_${tXXz}.grib2"
                echo ${newfilename}
        
                # This part assumes the filepath to [regrid directory]/[yyyymmdd] ALREADY EXISTS!
        		if ! test -f ${REGRID_PATH}/${yyyymmdd}/${newfilename}; then #hasn't been regridded yet - do it
                    # Extract 2 m temperature from main grib file, put it in the Regridded_HRRR_aidatadepot folder (no subfolder yet)
                    # This will then be regridded, and then overwritten by the next extracted 2m temp
                    wgrib2 ${file} -match "TMP:2 m" -grib ${REGRID_PATH}/${tmpfilename}
                
        			wgrib2 ${REGRID_PATH}/${tmpfilename} -set_radius 1:6370000 -set_grib_type c3 -set_bitmap 0 -new_grid_winds grid -new_grid_interpolation bilinear -new_grid ncep grid 184 ${REGRID_PATH}/${yyyymmdd}/${newfilename}
        			echo "${REGRID_PATH}/${yyyymmdd}/${newfilename} has been created"
        		else
        			echo "${newfilename} already exists in ${REGRID_PATH}/${yyyymmdd}"	
        		fi
            fi 
        fi 
    done #end working in [yyyymmdd] directory in /ai-datadepot/models/hrrr/conus/grib2
    
    cd .. #return to main grib2 directory (/ai-datadepot/models/hrrr/conus/grib2) to go to next day
    
done #end main loop

rm ${REGRID_PATH}/${tmpfilename} #to not mess up future work